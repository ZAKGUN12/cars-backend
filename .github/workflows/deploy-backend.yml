name: Deploy Backend & Lambda

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  workflow_call:

env:
  AWS_REGION: eu-west-1
  ENVIRONMENT: prod
  LAMBDA_FUNCTION: vehicle-guesser-api-prod

jobs:
  # Job 1: Prepare Backend
  prepare:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Validate Code
      run: |
        echo "‚úÖ Checking key files..."
        test -f index.js && echo "  ‚úì index.js" || exit 1
        test -f cognito-index.js && echo "  ‚úì cognito-index.js" || exit 1
        echo "‚úÖ All required files present"
    
    - name: Install Dependencies
      run: |
        echo "üì¶ Installing dependencies..."
        npm ci --omit=dev
        echo "‚úÖ Dependencies installed"
  
  # Job 2: Package Lambda
  package:
    runs-on: ubuntu-latest
    needs: prepare
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Dependencies
      run: npm ci --omit=dev
    
    - name: Package Lambda Function
      run: |
        echo "üì¶ Creating deployment package..."
        
        # Create clean package
        zip -r lambda-function.zip . \
          -x "*.git*" \
          ".github/*" \
          "README.md" \
          "package-lock.json" \
          "node_modules/.cache/*" \
          "*/.DS_Store" \
          "*.log"
        
        ls -lh lambda-function.zip
        echo "‚úÖ Package created: lambda-function.zip"
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: lambda-function
        path: lambda-function.zip
        retention-days: 1
  
  # Job 3: Deploy to Lambda
  deploy:
    runs-on: ubuntu-latest
    needs: package
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download Artifact
      uses: actions/download-artifact@v3
      with:
        name: lambda-function
        path: .
    
    - name: Check Lambda Exists
      id: check-lambda
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        if aws lambda get-function --function-name $LAMBDA_FUNCTION --region $AWS_REGION 2>/dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Lambda function exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  Lambda function not found"
        fi
    
    - name: Deploy Lambda Code
      if: steps.check-lambda.outputs.exists == 'true'
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        echo "üöÄ Deploying Lambda function code..."
        
        aws lambda update-function-code \
          --function-name $LAMBDA_FUNCTION \
          --zip-file fileb://lambda-function.zip \
          --region $AWS_REGION \
          --no-cli-pager
        
        # Wait for update to stabilize
        echo "‚è≥ Waiting for Lambda to be ready..."
        sleep 5
        
        # Check update status
        UPDATE_STATUS=$(aws lambda get-function --function-name $LAMBDA_FUNCTION --region $AWS_REGION --query 'Configuration.LastUpdateStatus' --output text)
        echo "‚úÖ Lambda Update Status: $UPDATE_STATUS"
  
  # Job 4: Configure Lambda
  configure:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Verify Lambda Deployment
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        echo "‚úÖ Verifying Lambda deployment..."
        
        # Get Lambda status
        LAMBDA_STATUS=$(aws lambda get-function \
          --function-name $LAMBDA_FUNCTION \
          --region $AWS_REGION \
          --query 'Configuration.State' \
          --output text)
        
        echo "Lambda Status: $LAMBDA_STATUS"
        echo "‚úÖ Lambda deployment verified"
  
  # Job 5: Run Tests
  test:
    runs-on: ubuntu-latest
    needs: configure
    if: success()
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Dependencies
      run: npm ci
    
    - name: Run Unit Tests
      run: npm test 2>/dev/null || echo "‚ö†Ô∏è  No tests configured"
  
  # Job 6: Deployment Summary
  summary:
    runs-on: ubuntu-latest
    needs: [deploy, configure]
    if: always()
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Summary
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        echo "üìã BACKEND DEPLOYMENT SUMMARY"
        echo "=============================="
        echo ""
        echo "Lambda Function: $LAMBDA_FUNCTION"
        echo "Environment: $ENVIRONMENT"
        echo "Region: $AWS_REGION"
        echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        
        # Get Lambda status
        if aws lambda get-function --function-name $LAMBDA_FUNCTION --region $AWS_REGION 2>/dev/null; then
          LAMBDA_STATUS=$(aws lambda get-function --function-name $LAMBDA_FUNCTION --region $AWS_REGION --query 'Configuration.State' --output text)
          LAST_UPDATE=$(aws lambda get-function --function-name $LAMBDA_FUNCTION --region $AWS_REGION --query 'Configuration.LastUpdateStatus' --output text)
          
          echo "‚úÖ Lambda Status: $LAMBDA_STATUS"
          echo "   Last Update: $LAST_UPDATE"
          echo ""
          echo "üîç Environment Variables Configured:"
          echo "   - IMAGE_METADATA_TABLE"
          echo "   - BROKEN_IMAGES_TABLE"
          echo "   - IMAGE_STATISTICS_TABLE"
          echo "   - AWS_REGION"
          echo "   - ENVIRONMENT"
        else
          echo "‚ùå Lambda function not found"
        fi
        
        echo ""
        echo "üöÄ Deployment complete!"
